<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">	
	<head>	  <meta charset="utf-8">
	
	<title>Glitch Recording Studio</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  

  <meta name="viewport" content="width=device-width, initial-scale=1">		
  <link rel="shortcut icon" type="image/png" href="/static/img/favicon.png" />

  <link rel="image_src" type="image/png" href="/static/img/icon.png" />

  <link href='http://fonts.googleapis.com/css?family=Signika:300' rel='stylesheet' type='text/css'>

  <link href='{{ compiled('style.scss') }}' rel='stylesheet' type='text/css' />

  <link href='{{ compiled('style-extra.scss') }}' rel='stylesheet' type='text/css' />
  
  <link href='{{ compiled(
  	'bar-ui.css',
	'sprites.css',
	'flashblock.css',
	'360player.css',
	'360player-visualization.css'
  ) }}' rel='stylesheet' type='text/css' />

  <link href='{{ compiled('style-responsive-players.scss') }}' rel='stylesheet' type='text/css' />
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css"> 
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css"> 
</head>
<body>
	<div id="username" style="display:none">{{ user_name }}</div>
	<header id="header" role="banner">
  	{% block user %}		
  		<div class="user">				
  			<p>Hello {{ user_name }}!</p>		
  		</div>		
  	{% end %}		
  	{% if notice %}
		<h2> {{ notice }} </h2>
	{% end %}
  		<a href="/" style="display:block;">		
		<div id="title-admin">				
		</div></a>	
  	</header>	
  	<br style="clear:both"/>  
  	<!--Pattern HTML-->	
  	<div class="secondary">
		 <section id="pattern" class="pattern">  	
			<ul class="grid">
				<li class="wide">		
					<div class="secondary-two">	
					<div id="info"></div>
				  <h2>Welcome to Glitch Recording Studio</h2>
					<p>I'm your engineer, Glitchy. </p>
					
					<div id="info"></div>
					Due to the magic of modern technology......</p>
				  <div class="errors">(This will only work in Chrome (version 3.2+) and recent versions of Firefox)</div>
				  <button  class="btn btn-default" onclick="startRecording(this);">Record</button>
				  <button   class="btn btn-default"  onclick="stopRecording(this);" disabled>Stop</button>
  
				  <h2>Recordings</h2>
				  <ul id="recordingslist"></ul>
				  <div id="upload_button" style="display:none"><a href='#' id="clickMe" class="btn btn-default">Upload</a></div>
				  <h2>Log</h2>
				  <pre id="log"></pre>
				  </div>		
 
					<div style="clear:both;"></div>	
				</li>			
				{% block right-nav %}			
				<li>				
					<nav role="navigation">					
						<div style="text-align: center"><ul>
							<li><a href="/create_account"><img src="static/img/sign-up.png" border="0" width="78" height="23" alt=""></a></li>
							<li><a href="/login"><img src="static/img/login-link.png" border="0" width="62" height="25" alt=""></a></li>
							<li><a href="/logout"><img src="static/img/logout-link.png" border="0" width="47" height="39" alt=""></a></li>
							<li><a href="/choice_chunks"><img src="static/img/segment-selection-link.png" border="0" width="82" height="38" alt=""></a></li>
							<li><a href="/submit"><img src="static/img/submit-link.png" border="0" width="137" height="26" alt=""></a></li>
							<li><a href="/oracle"><img src="static/img/magic-ball-link.png" border="0" width="114" height="96" alt=""></a></li>
							<li><a href="/credits"><img src="static/img/credits-link.png" border="0" width="85" height="21" alt=""></a></li>
						</ul></div>				
					</nav>			
				</li>					
			</ul>	
		</section>		
		{% end %}	
	</div>	
	
  <audio id='BackgroundTrack' src='/instrumentals/dgacousticlikMP3.mp3'/>


   <script type="text/javascript" src='https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js'></script>		
	<script type="text/javascript" src='{{ compiled('spin.min.js',		  
													'recorder.js') }}'>
	</script>	
	<script type="text/javascript" src='{{ compiled('remix.js') }}'>	
	<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

   <script type="text/javascript">

// Remix with any track.
// Uploads are supported by the Echo Nest's back-end servers.
// You're welcome to uses these servers for non-commercial projects and hacks

	// Remix with any track.
	// Uploads are supported by the Echo Nest's back-end servers.
	// You're welcome to uses these servers for non-commercial projects and hacks
	var apiKey = 'TX2IDAM1HXOO99YPB';
	var trackID;
	var trackURL;

	var remixer;
	var player;
	var track;
	var remixed;


	// Get an estimation of analysis time
	function fetchQinfo() {
		var url = 'http://labs.echonest.com/Uploader/qinfo?callback=?'
		$.getJSON(url, {}, function(data) {
			$("#info").text("Estimated analysis time: " + Math.floor(data.estimated_wait * 1.2) + " seconds.");
		});
	}

	// Get the analysis, if it is ready
	function analyzeAudio(audio, tag, callback) {
		var url = 'http://labs.echonest.com/Uploader/qanalyze?callback=?'
		$.getJSON(url, { url:audio, tag:tag}, function(data) {
			if (data.status === 'done' || data.status === 'error') {
				callback(data);
			} else {
				$("#info").text(data.status + ' - ready in about ' + data.estimated_wait + ' secs. ');
				setTimeout(function() { analyzeAudio(audio, tag, callback); }, 8000);
			} 
		});
	}
	function randomName()
	{
		var text = "";
		var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

		for( var i=0; i < 5; i++ )
			text += possible.charAt(Math.floor(Math.random() * possible.length));

		return text;
	}


	


</script>

	<div class="container">			
		<footer role="contentinfo">
			<div>				
				<!-- Amended February 28 -->
				<nav id="menu">
					<ul class="footer_menu">
					<li class="footerlist"><a href="/">Home</a> </li>
					<li class="footerlist"><font size="-1">&nbsp;&copy; 2014 Future Fossil</font></li>
					<li class="footerlist"><a href="mailto:beezwax@aol.com">Contact</a>	</li>
					<li class="footerlist"><a href="http://chrisbutler1.bandcamp.com" target="_newbrowser">Bandcamp</a>	</li>
					<li class="footerlist"><a href="http://www.futurefossilmusic.com/" title="Home for all things Chris Butler">Future Fossil Music</a></li>
					
					</ul>
				</nav>			
			</div>		
		</footer>	
	</div>				
		
</div>
	
	<script type="text/javascript" >
	jQuery.noConflict();
	jQuery( document ).ready(function( $ ) {				
		$(".title").click(function() {
			window.location = $(this).find("a").attr("href"); 		  
			return false;		
			});	
		});	
	</script>		
		<script type="text/javascript" src='{{ compiled('socket.io.js') }}'></script>
		  <script>

  function logHTML(e, data) {
    log.innerHTML += "\n" + e + " " + (data || '');
  }


  var audioContext;
  var audioRecorder;


  var _realAudioInput;
  
  function handlerStartUserMedia(stream) {

    console.log('handlerStartUserMedia');
    console.log('sampleRate:'+ audioContext.sampleRate);

    // MEDIA STREAM SOURCE -> ZERO GAIN >
    _realAudioInput = audioContext.createMediaStreamSource(stream);

    audioRecorder = new Recorder(_realAudioInput);


  }

  function handlerErrorUserMedia(e) {
      logHTML('No live audio input: ' + e);
  }

  function startRecording(button) {

    if(!audioRecorder)
      return;
    
   	var thissound=document.getElementById('BackgroundTrack');
    	thissound.load();
    	thissound.play();
 
    audioRecorder && audioRecorder.record();

    //GUI
    button.disabled = true;
    button.nextElementSibling.disabled = false;

    logHTML('Recording...');


  }

  function stopRecording(button) {

    if(!audioRecorder)
      return;

	   	var thissound=document.getElementById('BackgroundTrack');
    	thissound.pause();
   		thissound.currentTime = 0;
	
    audioRecorder && audioRecorder.stop();

    //GUI
    button.disabled = true;
    button.previousElementSibling.disabled = false;

    logHTML('Stopped recording.');
 

  }

  window.onload = function init() {

		var $ = jQuery
		$.noConflict()
		console.log(1111)
		console.log($)
		var contextFunction = window.webkitAudioContext || window.AudioContext;
		if (contextFunction === undefined) {
			$("#info").text("Sorry, this app needs advanced web audio. Your browser doesn't"
				+ " support it. Try the latest version of Chrome");
		}
		// Read the URL query string to decide what to do
		var params = {};
		var q = document.URL.split('?')[1];
		if(q != undefined){
			q = q.split('&');
			for(var i = 0; i < q.length; i++){
				var pv = q[i].split('=');
				var p = pv[0];
				var v = pv[1];
				params[p] = v;
			}
		}

		if ('key' in params) {
				console.log(2222)
		console.log($)

			// We just uploaded a track.
			// We need to log the trackID and the URL, and then redirect.
			$("#select-track").hide();
			$("#play-remix").hide();
			$("#info").text("Analyzing audio...");
			trackURL = 'http://' + params['bucket'] + '/' + urldecode(params['key']);

			analyzeAudio(trackURL, 'tag', function(data) {
				console.log(data)
				if (data.status === 'done') {
					var urlXHR = getReference(data.trid, function(data) {
						var newUrl = location.protocol + "//" +  location.host + location.pathname + "?trid=" + data.trid;
						location.href = newUrl;
					});
					urlXHR.fail(function() {
						postReference(data.trid, trackURL, function(data) {
							var newUrl = location.protocol + "//" +  location.host + location.pathname + "?trid=" + data.trid;
							location.href = newUrl;
						});
					});
				}
			});
		} 

		else if ('trid' in params) {
				console.log(3333)
		console.log($)

			// We were passed a trackID directly in the url
			// We can remix the track we get back!
			trackID = params['trid'];
			$("#play-remix").show();
			$("#select-track").hide();

			var urlXHR = getReference(trackID, function(data) {
					console.log(4444)
		console.log($)

				trackURL = data.trackURL;
				console.log("Ready to remix");
				var context = new contextFunction();
				var fs;
				// Only use the filesystem if we have access to it.
				if (window.File && window.FileReader && window.FileList && window.Blob && window.webkitRequestFileSystem) {
					window.requestFileSystem  = window.requestFileSystem || window.webkitRequestFileSystem;
					window.requestFileSystem(window.TEMPORARY, 1024*1024, function(filesystem) {
						fs = filesystem;
					}, fileErrorHandler);
				}

				var wavesurfer = Object.create(WaveSurfer);
				wavesurfer.init({
					canvas: document.querySelector('#waveCanvas'),
					waveColor: '#888888',
					progressColor: '#000000',
					loadingColor: '#000000',
					cursorColor: '#888888'
				});
			
				var remixedWavesurfer = Object.create(WaveSurfer);
				remixedWavesurfer.init({
					canvas: document.querySelector('#RemixedWaveCanvas'),
					waveColor: '#00ACEB',
					progressColor: '#000000',
					loadingColor: '#000000',
					cursorColor: '#00ACEB'
				});
				
				
				console.log($)
				console.log(5555)
				remixer = createJRemixer(context, $, apiKey);
				player = remixer.getPlayer();
				$("#info").text("Loading analysis data...");

				remixer.remixTrackById(trackID, trackURL, function(t, percent) {
					track = t;

					$("#info").text(percent + "% of the track loaded...");
					if (percent == 100) {
						$("#info").text(percent + "% of the track loaded, remixing...");
					}

					if (track.status == 'ok') {
						wavesurfer.loadBuffer(track.analysis.beats);

						$('.btn-original').removeAttr('disabled');
						remixed = new Array();
						// Extract the first beat of every bar.
						var meter = parseInt(track.analysis.track.time_signature);
						for (var i=0; i < track.analysis.beats.length; i++) {
							if (i % meter == 0) {
								remixed.push(track.analysis.beats[i])
							}
						}
						$("#info").text("Remix complete!");

						remixedWavesurfer.loadBuffer(remixed);

						// Only use the filesystem if we have access to it.
						if (fs) {
							remixer.saveRemixLocally(fs, remixed, function(saveURL) {
								$('#downloadButton').html('<a href="' + saveURL + '" target="_blank">Download Remix</a>')
							});
						}
						$('.btn-remixed').removeAttr('disabled');
					}
				});
			});
			urlXHR.error(function() {
				$("#info").text("Error getting the track URL - please try again...");
			});    

		} else {
			// We're waiting for the user to pick a track and upload it
			$("#play-remix").hide();
			$("#redirect-url").attr('value', document.URL);
			$("#f-filename").attr('value', 'remix_audio/' + randomName() + '.mp3');

			$("#file").change( 
				function() {
					var filename = $("#file").val();
					if (endsWith(filename.toLowerCase(), ".mp3")) {
						$("#f-filename").attr('value', fixFileName(filename));
						$("#upload").removeAttr('disabled');
					} else {
						alert('Sorry, this app only supports MP3s');
						$("#upload").attr('disabled', 'disabled');
					}
				}
			);
		console.log(11111)
			fetchSignature();
			fetchQinfo();
		}
      // webkit shim.
      window.AudioContext = window.AudioContext || window.webkitAudioContext || window.mozAudioContext;

      navigator.getUserMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);

      window.URL = window.URL || window.webkitURL;
      
      audioContext = new AudioContext;

      logHTML('Audio context set up.');
      logHTML('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));

    //} catch (e) {

    //  alert('No web audio support in this browser!');

    //}

    
    navigator.getUserMedia({vide:false, audio: true}, handlerStartUserMedia, handlerErrorUserMedia);

  };

  </script>
	</body>
		</html>